From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Peridot <peridot491@protonmail.com>
Date: Tue, 20 Jun 2023 01:19:13 +0200
Subject: [PATCH] Prevent most NBT overflow related exploits


diff --git a/src/main/java/net/minecraft/server/PacketDataSerializer.java b/src/main/java/net/minecraft/server/PacketDataSerializer.java
index 8927cc93ed70f344214f4dea0466bb93d5370d7b..d95033bfdc00aa0c68772f9ad4d8f5005aabce96 100644
--- a/src/main/java/net/minecraft/server/PacketDataSerializer.java
+++ b/src/main/java/net/minecraft/server/PacketDataSerializer.java
@@ -22,6 +22,7 @@ import java.nio.charset.Charset;
 import java.util.UUID;
 
 import org.bukkit.craftbukkit.inventory.CraftItemStack; // CraftBukkit
+import org.mythicprojects.unicornspigot.config.UnicornConfig;
 
 public class PacketDataSerializer extends ByteBuf {
 
@@ -167,7 +168,7 @@ public class PacketDataSerializer extends ByteBuf {
             return null;
         } else {
             this.readerIndex(i);
-            return NBTCompressedStreamTools.a((DataInput) (new ByteBufInputStream(this)), new NBTReadLimiter(2097152L));
+            return NBTCompressedStreamTools.a((DataInput) (new ByteBufInputStream(this)), new NBTReadLimiter(UnicornConfig.get().exploits.nbtReadLimiter)); // Unicorn
         }
     }
 
diff --git a/src/main/java/org/mythicprojects/unicornspigot/config/UnicornConfig.java b/src/main/java/org/mythicprojects/unicornspigot/config/UnicornConfig.java
index c697a55566e3a2c56861b50c502b97956ef91ad7..8c239769bbd3e110164a939cde6bde8658416ee5 100644
--- a/src/main/java/org/mythicprojects/unicornspigot/config/UnicornConfig.java
+++ b/src/main/java/org/mythicprojects/unicornspigot/config/UnicornConfig.java
@@ -45,6 +45,18 @@ public class UnicornConfig extends EngineConfig<UnicornWorldConfig> {
 
     }
 
+    @Comment("Configuration of exploits fixes that could be used to crash the server or cause other issues.")
+    public Exploits exploits = new Exploits();
+
+    public static class Exploits extends UnicornConfigSection {
+
+        @Comment("The max NBT size in bytes server would read.")
+        @Comment("The default value is 2097152 which is ~2Mb - it's huge and allow to use exploits or dupe items.")
+        @Comment("UnicornSpigot by default sets it to 50000 which is ~50Kb - it should be enough for most plugins.")
+        public long nbtReadLimiter = 50000L;
+
+    }
+
     @Comment("Per world settings.")
     public Map<String, UnicornWorldConfig> worldSettings = new HashMap<>();
 
